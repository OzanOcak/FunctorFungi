<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Setting Up Drizzle on an RPC Server | Functor Fungi</title>
<meta name="keywords" content="drizzle, docker, express, api">
<meta name="description" content="Drizzle">
<meta name="author" content="Ozan">
<link rel="canonical" href="http://localhost:1313/posts/drizzle/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fbb87958984962319e2ee793c41502ed8d6f6d6bccad4d0be2ba9c4f82f0e08c.css" integrity="sha256-&#43;7h5WJhJYjGeLueTxBUC7Y1vbWvMrU0L4rqcT4Lw4Iw=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/drizzle/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Functor Fungi (Alt + H)">Functor Fungi</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Setting Up Drizzle on an RPC Server
    </h1>
    <div class="post-description">
      Drizzle
    </div>
    <div class="post-meta"><span title='2024-11-14 15:00:06 -0500 EST'>November 14, 2024</span>&nbsp;·&nbsp;Ozan

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="http://localhost:1313/img/posts/4.png" alt="Abstract Image">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#install-required-packages" aria-label="Install Required Packages">Install Required Packages</a></li>
                <li>
                    <a href="#set-up-the-project-structure" aria-label="Set Up the Project Structure">Set Up the Project Structure</a></li>
                <li>
                    <a href="#create-configuration-files" aria-label="Create Configuration Files">Create Configuration Files</a></li>
                <li>
                    <a href="#environment-variables" aria-label="Environment Variables">Environment Variables</a></li>
                <li>
                    <a href="#drizzle-configuration" aria-label="Drizzle Configuration">Drizzle Configuration</a></li>
                <li>
                    <a href="#update-package-scripts" aria-label="Update Package Scripts">Update Package Scripts</a></li>
                <li>
                    <a href="#database-connection" aria-label="Database Connection">Database Connection</a></li>
                <li>
                    <a href="#database-migrations" aria-label="Database Migrations">Database Migrations</a></li>
                <li>
                    <a href="#defining-the-schema" aria-label="Defining the Schema">Defining the Schema</a></li>
                <li>
                    <a href="#seeding-the-database" aria-label="Seeding the Database">Seeding the Database</a></li>
                <li>
                    <a href="#running-the-setup" aria-label="Running the Setup">Running the Setup</a></li>
                <li>
                    <a href="#using-drizzle-studio" aria-label="Using Drizzle Studio">Using Drizzle Studio</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>In this blog post, we will walk through the process of setting up Drizzle ORM on a typed RPC server which we have built previous plog post, using PostgreSQL. We will cover the installation of necessary packages, configuration files, and how to seed the database. Let’s get started!</p>
<h3 id="install-required-packages">Install Required Packages<a hidden class="anchor" aria-hidden="true" href="#install-required-packages">#</a></h3>
<p>First, we need to install the necessary dependencies for Drizzle ORM and PostgreSQL. Open your terminal and run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install drizzle-orm pg dotenv
</span></span><span style="display:flex;"><span>npm install -D drizzle-kit @types/pg nodemon tsx
</span></span></code></pre></div><p>This command installs Drizzle ORM for database interactions, the PostgreSQL client, and development tools like nodemon for automatic server restarts.</p>
<h3 id="set-up-the-project-structure">Set Up the Project Structure<a hidden class="anchor" aria-hidden="true" href="#set-up-the-project-structure">#</a></h3>
<p>Next, we’ll create a basic project structure. Run the following commands to create the required directories and files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir db
</span></span><span style="display:flex;"><span>touch db/dbConn.ts db/migrate.ts db/schema.ts
</span></span></code></pre></div><p>This creates a db directory where we will store our database connection, migration scripts, and schema definitions.</p>
<h3 id="create-configuration-files">Create Configuration Files<a hidden class="anchor" aria-hidden="true" href="#create-configuration-files">#</a></h3>
<p>We will create three configuration files in the root of the project directory, at the same level as package.json: .env, docker-compose.yaml, and drizzle.config.ts.</p>
<p>Docker Configuration
Here’s an example docker-compose.yaml file to set up a PostgreSQL database:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">authapp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">postgres:16</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">POSTGRES_USER=${DB_USERNAME}</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">POSTGRES_PASSWORD=${DB_PASSWORD}</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">POSTGRES_DB=${DB_NAME}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">${DB_PORT}:5432</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">db-data:/var/lib/postgresql/data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  adminer:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    image: adminer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    restart: always</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    ports:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#      - 8080:8080</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">db-data</span>:
</span></span></code></pre></div><p>In this configuration, we define a PostgreSQL service with environment variables that will be populated from our .env file. Note that we commented out the Adminer service, as it is not needed for our setup with Drizzle ORM.</p>
<h3 id="environment-variables">Environment Variables<a hidden class="anchor" aria-hidden="true" href="#environment-variables">#</a></h3>
<p>Next, create a .env file to store environment variables:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>DB_HOST=localhost
</span></span><span style="display:flex;"><span>DB_USERNAME=postgres
</span></span><span style="display:flex;"><span>DB_PASSWORD=postgres
</span></span><span style="display:flex;"><span>DB_NAME=database
</span></span><span style="display:flex;"><span>DB_PORT=5432
</span></span><span style="display:flex;"><span>PORT=4000
</span></span><span style="display:flex;"><span>DATABASE_URL=postgres://postgres:postgres@localhost:5432/database
</span></span></code></pre></div><p>This file contains the configuration for connecting to your PostgreSQL database. Make sure to adjust the values as necessary for your setup.</p>
<h3 id="drizzle-configuration">Drizzle Configuration<a hidden class="anchor" aria-hidden="true" href="#drizzle-configuration">#</a></h3>
<p>Now, let&rsquo;s set up the Drizzle configuration by creating drizzle.config.ts:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">dotenv</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;dotenv&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">defineConfig</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;drizzle-kit&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dotenv</span>.<span style="color:#a6e22e">config</span>(); <span style="color:#75715e">// Load environment variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">defineConfig</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dialect</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;postgresql&#34;</span>, <span style="color:#75715e">// &#34;mysql&#34; | &#34;sqlite&#34; | &#34;postgresql&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">schema</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;./src/db/schema/index.ts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">out</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;src/drizzle&#34;</span>, <span style="color:#75715e">// drizzle folder should be under src directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">dbCredentials</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">url</span>: <span style="color:#66d9ef">process.env.DATABASE_URL</span><span style="color:#f92672">!</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This configuration file tells Drizzle ORM how to connect to the database and where to find the schema.</p>
<h3 id="update-package-scripts">Update Package Scripts<a hidden class="anchor" aria-hidden="true" href="#update-package-scripts">#</a></h3>
<p>Next, we’ll add some scripts to our package.json to streamline our development workflow. Here’s how to modify the scripts section:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;dev:api&#34;</span>: <span style="color:#e6db74">&#34;tsx src/api/index.ts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;dev:client&#34;</span>: <span style="color:#e6db74">&#34;tsx src/client/index.ts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;dev&#34;</span>: <span style="color:#e6db74">&#34;nodemon --exec ts-node src/server.ts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;seed&#34;</span>: <span style="color:#e6db74">&#34;tsx src/db/seed.ts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;build&#34;</span>: <span style="color:#e6db74">&#34;tsc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;db:generate&#34;</span>: <span style="color:#e6db74">&#34;npx drizzle-kit generate --config=&#39;./drizzle.config.ts&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;db:push&#34;</span>: <span style="color:#e6db74">&#34;npx ts-node src/db/migrate.ts&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;migrate&#34;</span>: <span style="color:#e6db74">&#34;npx drizzle-kit generate --config=&#39;./drizzle.config.ts&#39; &amp;&amp; npx ts-node src/db/migrate.ts&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>These scripts allow you to run the API, client, database migrations, and seeding commands easily.</p>
<h3 id="database-connection">Database Connection<a hidden class="anchor" aria-hidden="true" href="#database-connection">#</a></h3>
<p>We start by establishing a connection to our PostgreSQL database using the dbConn.ts file. Here’s how the code looks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#75715e">// db/dbConn.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">dotenv</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;dotenv&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Pool</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;pg&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">drizzle</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;drizzle-orm&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">schema</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./schema&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dotenv</span>.<span style="color:#a6e22e">config</span>(); <span style="color:#75715e">// Load environment variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// PostgreSQL connection configuration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pool</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Pool</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">host</span>: <span style="color:#66d9ef">process.env.DB_HOST</span><span style="color:#f92672">!</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">port</span>: <span style="color:#66d9ef">Number</span>(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">DB_PORT</span><span style="color:#f92672">!</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">user</span>: <span style="color:#66d9ef">process.env.DB_USERNAME</span><span style="color:#f92672">!</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">password</span>: <span style="color:#66d9ef">process.env.DB_PASSWORD</span><span style="color:#f92672">!</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">database</span>: <span style="color:#66d9ef">process.env.DB_NAME</span><span style="color:#f92672">!</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Initialize the database connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">drizzle</span>(<span style="color:#a6e22e">pool</span>, { <span style="color:#a6e22e">schema</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Connection state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">isConnected</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to connect the database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">connectDatabase() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isConnected</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">connect</span>(); <span style="color:#75715e">// Connect to the database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">isConnected</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; <span style="color:#75715e">// Update the connection state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Connected to PostgreSQL database&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Connection error&#34;</span>, <span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Already connected to PostgreSQL database&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Call the connect function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">connectDatabase</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Export the client and db for use in other parts of your application
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> { <span style="color:#a6e22e">pool</span>, <span style="color:#a6e22e">db</span> };
</span></span></code></pre></div><p>In this file:</p>
<p>We load environment variables using dotenv.
We configure a connection pool to PostgreSQL.
We create a Drizzle ORM instance with the database connection and schema.</p>
<h3 id="database-migrations">Database Migrations<a hidden class="anchor" aria-hidden="true" href="#database-migrations">#</a></h3>
<p>Next, we need to perform database migrations to create the necessary tables. The migrate.ts file will handle this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#75715e">// db/migrate.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">pool</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./dbConn&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">migrate</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;drizzle-orm&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">migrateDatabase</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">connect</span>(); <span style="color:#75715e">// Get a client from the pool
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Connected to PostgreSQL database for migrations.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Perform the migrations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">migrate</span>(<span style="color:#a6e22e">db</span>, { <span style="color:#a6e22e">migrationsFolder</span>: <span style="color:#66d9ef">resolve</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;../drizzle&#34;</span>) });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Migrations completed successfully.&#34;</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Migration error:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">release</span>(); <span style="color:#75715e">// Ensure the client is closed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;PostgreSQL client disconnected.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">migrateDatabase</span>();
</span></span></code></pre></div><p>Here, we:</p>
<p>Connect to the database and execute migrations defined in the specified folder.
Ensure the client is released after the operation, preventing resource leaks.</p>
<h3 id="defining-the-schema">Defining the Schema<a hidden class="anchor" aria-hidden="true" href="#defining-the-schema">#</a></h3>
<p>We define our database schema in the schema directory. For example, the category.ts file defines a category table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#75715e">// db/schema/category.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">pgTable</span>, <span style="color:#a6e22e">serial</span>, <span style="color:#a6e22e">varchar</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;drizzle-orm&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">category</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pgTable</span>(<span style="color:#e6db74">&#34;category&#34;</span>, {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">serial</span>(<span style="color:#e6db74">&#34;id&#34;</span>).<span style="color:#a6e22e">primaryKey</span>(),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">varchar</span>(<span style="color:#e6db74">&#34;name&#34;</span>, { <span style="color:#a6e22e">length</span>: <span style="color:#66d9ef">255</span> }).<span style="color:#a6e22e">notNull</span>().<span style="color:#66d9ef">unique</span>(),
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This schema represents a simple category table with an auto-incrementing id and a unique name.</p>
<h3 id="seeding-the-database">Seeding the Database<a hidden class="anchor" aria-hidden="true" href="#seeding-the-database">#</a></h3>
<p>Now, let&rsquo;s seed our database with initial data. We have our seed data defined in JSON format:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#75715e">// db/seeds/data/categories.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Italy&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;France&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Poland&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Germany&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Holland&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Spain&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Norway&#34;</span> }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>Next, we implement the seeding logic in category.ts:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#75715e">// db/seeds/category.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">category</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;../schema/category&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DB</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;drizzle-orm&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">categories</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">require</span>(<span style="color:#e6db74">&#34;./data/categories.json&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">seed</span>(<span style="color:#a6e22e">db</span>: <span style="color:#66d9ef">DB</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">insert</span>(<span style="color:#a6e22e">category</span>).<span style="color:#a6e22e">values</span>(<span style="color:#a6e22e">categories</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Finally, we create a seed.ts file to reset the tables and run the seeding function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#75715e">// db/seed.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">db</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./dbConn&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">category</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./schema/category&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">seed</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">categorySeed</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;./seeds/category&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">resetTable</span>(<span style="color:#a6e22e">db</span>: <span style="color:#66d9ef">DB</span>, <span style="color:#a6e22e">table</span>: <span style="color:#66d9ef">Table</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">sql</span><span style="color:#e6db74">`truncate table </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">table</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> restart identity cascade`</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">table</span> <span style="color:#66d9ef">of</span> [<span style="color:#a6e22e">category</span>]) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">resetTable</span>(<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">table</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">categorySeed</span>(<span style="color:#a6e22e">db</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>  .<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">e</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">e</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  .<span style="color:#66d9ef">finally</span>(<span style="color:#66d9ef">async</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Seeding done!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  });
</span></span></code></pre></div><p>This script truncates the existing data and inserts the new seed data.</p>
<h3 id="running-the-setup">Running the Setup<a hidden class="anchor" aria-hidden="true" href="#running-the-setup">#</a></h3>
<p>Now that everything is set up, here’s how to run your application:</p>
<p>Start Docker: Spin up your PostgreSQL container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker compose up -d
</span></span></code></pre></div><p>Run the API: Start your API server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm run dev:api
</span></span></code></pre></div><p>Migrate the Database: Apply the migrations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm run migrate
</span></span></code></pre></div><p>Seed the Database: Populate the database with initial data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm run seed
</span></span></code></pre></div><p>Run the Client: Start your client application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm run dev:client
</span></span></code></pre></div><p>Querying the Database
Once your server is running, you can query the database through your RPC API. The API will return a JSON response with the seeded data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Italy&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;France&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">3</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Poland&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Germany&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">5</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Holland&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">6</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Spain&#34;</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">7</span>, <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Norway&#34;</span> }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="using-drizzle-studio">Using Drizzle Studio<a hidden class="anchor" aria-hidden="true" href="#using-drizzle-studio">#</a></h3>
<p>To visualize your database schema and data, you can use Drizzle Studio by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npx drizzle-kit studio
</span></span></code></pre></div><p>This will provide a user-friendly interface to interact with your database.</p>
<h3 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h3>
<p>You have successfully set up a typed RPC API connected to a PostgreSQL database using Drizzle ORM. You learned how to configure the database connection, create migrations, seed initial data, and interact with the database via an API. This setup provides a robust foundation for building scalable applications.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/drizzle/">Drizzle</a></li>
      <li><a href="http://localhost:1313/tags/docker/">Docker</a></li>
      <li><a href="http://localhost:1313/tags/express/">Express</a></li>
      <li><a href="http://localhost:1313/tags/api/">Api</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Functor Fungi</a></span>
       
   
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
